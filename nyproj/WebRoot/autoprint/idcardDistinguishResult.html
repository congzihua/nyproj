<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html;" charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>身份识别结果页面</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/user.css">
    <link rel="stylesheet" href="./css/style.css">
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="./js/rem.js"></script>
    <script type="text/javascript" src="js/reconnecting-websocket.min.js"></script>
    <script type="text/javascript" src="js/offline.min.js"></script>
</head>

<body>
    <div class="main">
        <div class="header">
            <div class="cardinfo-box">
                <div class="name-box">姓名：&nbsp;&nbsp;&nbsp;<span id="name"></span></div>
                <div class="id-box">身份证号：&nbsp;&nbsp;&nbsp;<span id="card"></span></div>
            </div>
            <button class="btn" id="back">退出</button>
        </div>
        <div class="info-content" id="content">
        </div>
        <div class="sky">
            <div class="clouds_one"></div>
            <div class="clouds_two"></div>
            <div class="clouds_three"></div>
            <div class="clouds_forth"></div>
            <div class="clouds_one top"></div>
            <div class="clouds_two top"></div>
            <div class="clouds_three top"></div>
            <div class="clouds_forth top"></div>
        </div>
    </div>
    <div class="time-box">
        <div class="an-time"></div>
        <span id="timenum">30</span>
    </div>
    <div id="box-typeinfo">
        <span id="infoBox"></span>
    </div>
</body>
<script>
    Date.prototype.Format = function (fmt) {
        var o = {
            "M+": this.getMonth() + 1, //月份
            "d+": this.getDate(), //日
            "h+": this.getHours(), //小时
            "m+": this.getMinutes(), //分
            "s+": this.getSeconds(), //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            S: this.getMilliseconds(), //毫秒
        };
        if (/(y+)/.test(fmt))
            fmt = fmt.replace(
                RegExp.$1,
                (this.getFullYear() + "").substr(4 - RegExp.$1.length)
            );
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt))
                fmt = fmt.replace(
                    RegExp.$1,
                    RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length)
                );
        return fmt;
    };
    var varItem1 = 'MB1.PRN^LPT1^4008^2012-01-22^是^1-A^库尔勒^北京^4-6^08:30^科比布莱恩提^220111198804153641^12';
    var varDemo1 = 'MB1.PRN^LPT1^';
    var socketUrl = 'ws://localhost:7302/PrintServer';
    var socket = null;
    var time = 30;
    var timer = null;
    var item = $('#timenum');
    var value = "";
    var inputTimer = null;
    item.text(time);
    timerStart();
    function timerStart() {
        if (time <= 0) {
            clearTimeout(timer);
            window.location.href = "autoprintIndex.html"
        } else {
            timer = setTimeout(() => {
                time -= 1;
                item.text(time);
                timerStart();
            }, 1000)
        }

    }

    var urlinfo = window.location.href;
    // var status = urlinfo.split("?")[1].split("=")[1];
    var CARD = urlinfo.split("?")[1].split("=")[1];
    console.log(CARD)

    window.onload = function () {
        getCard()
        // getInfo()
    }
    $('#back').bind('click', function () {
        console.log(1)
        window.location.href = "autoprintIndex.html"
    });
    var nyprojUrl = "http://localhost:8089";
    function getCard() {
        $.ajax({
            dataType: "text",
            type: "get",
            url: nyprojUrl + "/nyproj/docAction.do?method=getUserFlightInfos&idcard=" + CARD,
            success: function (data) {
                if (!data) {
<<<<<<< HEAD
                    alert("当前无登机牌信息");
=======
                    var html = "";
                    html = '<div class="info-box">' +
                        '<div class="row">' +
                        '<div class="row-title">序号</div>' +
                        '<div class="row-title">航程</div>' +
                        '<div class="row-title">乘机日期</div>' +
                        '<div class="row-title">起飞时间</div>' +
                        '<div class="row-title">状态</div>' +
                        '<div class="row-title">操作</div>' +
                        '</div>';
                        html += '<div class="row">未查询到当日购票信息</div>';
                        
                        html += '</div>';
                        $("#content").append(html);
>>>>>>> refs/remotes/origin/temp_flight
                    return;
                }
                let list = JSON.parse(data).map(function (item, index) {
                    return item;
                });
<<<<<<< HEAD
=======
                var html = "";
                if (list.length == 0) {
                    html = '<div class="info-box">' +
                        '<div class="row">' +
                        '<div class="row-title">序号</div>' +
                        '<div class="row-title">航程</div>' +
                        '<div class="row-title">乘机日期</div>' +
                        '<div class="row-title">起飞时间</div>' +
                        '<div class="row-title">状态</div>' +
                        '<div class="row-title">操作</div>' +
                        '</div>';
                        html += '<div class="row">未查询到当日购票信息</div>';
                        
                        html += '</div>';
                        $("#content").append(html);
                    return;
                }
>>>>>>> refs/remotes/origin/temp_flight
                $('#name').text(list[0].name);
                var certNo = list[0].certNo;
                certNo = certNo.substring(0, 6) + "******" + certNo.substring(14);
                $('#card').text(certNo);
                $.each(list, function (k, v) {
                    html = '<div class="info-box">' +
                        '<div class="row">' +
                        '<div class="row-title">序号</div>' +
                        '<div class="row-title">航程</div>' +
                        '<div class="row-title">乘机日期</div>' +
                        '<div class="row-title">起飞时间</div>' +
                        '<div class="row-title">状态</div>' +
                        '<div class="row-title">操作</div>' +
                        '</div>';
                    var statusValue = '';
                    if (v.status == 2) {
                        statusValue = '待换登机牌';
                    } else if (v.status == 3) {
                        statusValue = '待安检';
                    } else if (v.status == 4) {
                        statusValue = '待登机';
                    }
                    html += '<div class="row">' +
                        '<div class="row-num">' + k + '</div>' +
                        '<div class="row-num">' + v.flight + '</div>' +
                        '<div class="row-num">' + new Date(v.flightDate).Format("yyyy-MM-dd") + '</div>' +
                        '<div class="row-num">' + v.flyTime + '</div>' +

                        '<div class="row-num">' + statusValue + '</div>' +
                        '<div class="row-num">' + '<a href="javascript:void(0)" onClick="upDate(' + v.id + ')">打印登机牌</a>' + '</div>' +
                        '</div>';
                    html += '</div>';
<<<<<<< HEAD
                    $("#content").append(html);

                })
=======
                });
                $("#content").append(html);
>>>>>>> refs/remotes/origin/temp_flight
            },
            error: function (e) {
                //失败执行
                console.log(e);
            },
        });

    }
	var msg = '登机牌打印已成功！';

    function upDate(key, e) {
        var event = e || window.event
        $.ajax({
            dataType: "text",
            type: "get",
            url: nyprojUrl + "/nyproj/docAction.do?method=toQueryPrintInfoById&ids=" + key,
            success: function (data) {
<<<<<<< HEAD
                //失败执行
=======
            	//失败执行
>>>>>>> refs/remotes/origin/temp_flight
                let list = JSON.parse(data).map(function (item, index) {
                    return item;
                });
                var certNo = list[0].certNo;
                var certType = list[0].certType;
                var id = list[0].id;
                var name = list[0].name;
                var vipFlag = list[0].vipFlag;
                var seatNum = list[0].seatNum;
                var gate = list[0].gate;
                var flightTo = list[0].flight;
                var flyTime = list[0].flyTime;
                var flightDate = list[0].flightDateFormate;
                var flightNo = list[0].flightNo;
                var startAddress = list[0].startAddress;
                $(event.target).addClass('active');
                //todo print 
                PrintLab1(flightNo, flightDate, vipFlag, seatNum, flightTo, gate, flyTime, name, certNo, id,startAddress);
                $('#infoBox').text(msg)
                msg = '登机牌打印已成功！';
            },
            error: function (e) {
                
            },
            error: function (e) {

            },
        });
       
        $('#box-typeinfo').addClass('dis')
        setTimeout(function () {
            $('#box-typeinfo').removeClass('dis')
        }, 2000)
    }

    
    function getInfo() {
        $.ajax({
            dataType: "JSONP",
            type: "get",
            url: nyprojUrl + "/nyproj/docAction.do?method=toQueryPrintInfoById&ids=" + status,
            success: function (data) {
                console.log(data)
                // let idList = data.map(function (item, index) {
                //     return item.id
                // })
                // let param = idList.join(",");
                // window.location.href = "idcardDistinguishResult.html?ids=" + param
            },
            error: function (e) {
                //失败执行
                console.log(e)

            },
        })
    }
    function timerStart() {
        if (time < 0) {
            clearTimeout(timer);
            window.location.href = "autoprintIndex.html"
        } else {
            timer = setTimeout(() => {
                time -= 1;
                item.text(time);
                console.log(time)
                timerStart();
            }, 1000)
        }

    }

    //打印登机牌方法
    function PrintLab1(a, b, c, d, e, f, flyTime, h, i, g,startAddress) {
        var flightNo = a;
        var flydate = b;
        var vipFlag = c;
        if (vipFlag == 1 || vipFlag == '1'|| vipFlag == '是') {
            vipFlag = "是";
            msg = 'VIP客户请到柜台办理登机牌！';
            return ;
        } else {
            vipFlag = " ";
        }
        var seatNum = d;
        var flightTo = e;
        var gate = f;
        // var flyhour = g;
        // var flyminute = h;
        var flytime = flyTime;
        var name = h;
        var certNo = i;
        var id = g;
        if (certNo.length == 18) {
            certNo = certNo.substring(0, 6) + "******" + certNo.substring(14);
        }
        if (seatNum == null || seatNum == '') {
        	msg = '座位数量不足，请到柜台办理或改签！';
            return;
        }
		//varItem1 = flightNo+'^'+flydate+'^'+vipFlag+'^'+seatNum+'^'+flightTo+'^<%=startAddress%>^'+gate+'^'+flytime+'^'+name+'^'+certNo+'^'+id;
        varItem1 = flightNo + '^' + flydate + '^' + vipFlag + '^' + seatNum + '^' + flightTo + '^'+startAddress+'^' + gate + '^' + flytime + '^' + name + '^' + certNo + '^' + id;
        var pData = varDemo1 + varItem1;
        buildSocket();
        socket.onopen = function (event) {
            socketStatus = true;
            if (socket.readyState == 1) {
                socket.send(pData);
            }
        }
        socket.onmessage = function (event) {
            socketStatus = false;
            pData = '';
            socket.close();
        };
        socket.onerror = function (evnt) {
            socketStatus = false;
        };
        socket.onclose = function (event) {
            socketStatus = false;
            socket = null;
        };
    }
    function buildSocket() {
        if ('WebSocket' in window) {
            socket = new ReconnectingWebSocket(socketUrl);
        } else if ('MozWebSocket' in window) {
            socket = new MozWebSocket(socketUrl);
        } else {
            socket = new SockJS(socketUrl);
        }
    };
</script>

</html>