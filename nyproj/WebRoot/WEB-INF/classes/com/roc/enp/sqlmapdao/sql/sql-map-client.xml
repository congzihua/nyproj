<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="client">  
	<resultMap class="com.roc.syspe.entity.OpOrdertickets" id="ooOpOrdertickets">
	  <result property="flightId" column="FLIGHT_ID"/>
	   <result property="flightDate" column="FLIGHT_DATE"/>
	   <result property="flyTime" column="FLY_TIME"/>
	   <result property="status" column="STATUS"/>
	   <result property="name" column="NAME"/>
	   <result property="flightinfoId" column="FLIGHTINFO_ID"/>	
	   <result property="certType" column="CERT_TYPE"/>
	   <result property="certNo" column="CERT_NO"/>
	   <result property="linkphone" column="LINKPHONE"/>
	   <result property="vipFlag" column="VIP_FLAG"/>	 
	   
	   <result property="ticketpointId" column="TICKETPOINT_ID"/>
	   <result property="flightNo" column="FLIGHT_NO"/>
	   <result property="payment" column="PAYMENT"/>
	   <result property="ticketprice" column="TICKETPRICE"/>
	   <result property="remark" column="REMARK"/>
	   <result property="gate" column="GATE"/>	
	   <result property="halfpricecard" column="HALFPRICECARD"/>
	   <result property="zeropricecard" column="ZEROPRICECARD"/>
	   <result property="createdate" column="CREATEDATE"/>
	   <result property="deleteFlag" column="DELETE_FLAG"/>	
	   
	   <result property="id" column="id"/>
	   <result property="luggSum" column="LUGG_SUM"/>	
	   <result property="weightSum" column="WEIGHT_SUM"/>
	   <result property="flight" column="FLIGHT"/>	
	  
	    <result property="gateTime" column="GATE_TIME"/>	
	     <result property="seatNum" column="SEAT_NUM"/>	
	     <result property="priceId" column="PRICE_ID"/>
	     <result property="ticketpointname" column="ticketpointname"/>
	     <result property="teamflag" column="TEAMFLAG"/>
	      <result property="teamName" column="TEAM_NAME"/>
	      <result property="bagNum" column="bag_num"/>
    </resultMap>
    <resultMap class="com.roc.syspe.entity.OpOrdertickets" id="ooRMKZZX">
	   <result property="status" column="STATUS"/>
	   <result property="name" column="NAME"/>
	   <result property="flightinfoId" column="FLIGHTINFO_ID"/>	
	   <result property="certType" column="CERT_TYPE"/>
	   <result property="certNo" column="CERT_NO"/>
	   <result property="linkphone" column="LINKPHONE"/>
	   <result property="vipFlag" column="VIP_FLAG"/>	 
	   <result property="ticketpointId" column="TICKETPOINT_ID"/>
	   <result property="flightNo" column="FLIGHT_NO"/>
	   <result property="payment" column="PAYMENT"/>
	   <result property="ticketprice" column="TICKETPRICE"/>
	   <result property="remark" column="REMARK"/>
	   <result property="gate" column="GATE"/>	
	   <result property="halfpricecard" column="HALFPRICECARD"/>
	   <result property="zeropricecard" column="ZEROPRICECARD"/>
	   <result property="createdate" column="CREATEDATE"/>
	   <result property="deleteFlag" column="DELETE_FLAG"/>	
	   <result property="id" column="ID"/>
	   <result property="luggSum" column="LUGG_SUM"/>	
	   <result property="weightSum" column="WEIGHT_SUM"/>
	   <result property="flight" column="FLIGHT"/>
	   <result property="flightDate" column="FLIGHT_DATE"/>
	   <result property="flyTime" column="FLY_TIME"/>
    </resultMap>  
    <resultMap class="com.roc.syspe.entity.OpOrdertickets" id="ooAtDJP">
	   <result property="name" column="NAME"/>
	   <result property="certType" column="CERT_TYPE"/>
	   <result property="status" column="STATUS"/>
	   <result property="certNo" column="CERT_NO"/>
	   <result property="linkphone" column="LINKPHONE"/>
	   <result property="seatNum" column="SEAT_NUM"/>
	   <result property="id" column="ID"/>
	   <result property="flightNo" column="flight_no"/>
	   <result property="flight" column="FLIGHT"/>	
    </resultMap>  
    <resultMap class="com.roc.syspe.entity.OpOrdertickets" id="ooForUnitsInfos">
    	<result property="flightId" column="FLIGHT_ID"/>
			<result property="flightDate" column="FLIGHT_DATE"/>
	
			<result property="status" column="STATUS"/>
			<result property="name" column="NAME"/>
			<result property="flightinfoId" column="FLIGHTINFO_ID"/>	
			<result property="certType" column="CERT_TYPE"/>
			<result property="certNo" column="CERT_NO"/>
			<result property="linkphone" column="LINKPHONE"/>
			<result property="vipFlag" column="VIP_FLAG"/>	 
	
			<result property="ticketpointId" column="TICKETPOINT_ID"/>
			<result property="flightNo" column="FLIGHT_NO"/>
			<result property="payment" column="PAYMENT"/>
			<result property="ticketprice" column="TICKETPRICE"/>
			<result property="remark" column="REMARK"/>
			<result property="gate" column="GATE"/>	
			<result property="halfpricecard" column="HALFPRICECARD"/>
			<result property="zeropricecard" column="ZEROPRICECARD"/>
	
			<result property="deleteFlag" column="DELETE_FLAG"/>	
	
			<result property="id" column="id"/>
			<result property="luggSum" column="LUGG_SUM"/>	
			<result property="weightSum" column="WEIGHT_SUM"/>
			<result property="flight" column="FLIGHT"/>	
			<result property="gateTime" column="GATE_TIME"/>	
	  		<result property="priceId" column="PRICE_ID"/>
			<result property="discountType" column="DISCOUNT_TYPE"/>
			<result property="realAmount" column="REAL_AMOUNT"/>
    </resultMap>    
    <resultMap class="com.roc.syspe.entity.OpOrdertickets" id="ooBaFligInfo">
	  <result property="flightId" column="FLIGHT_ID"/>
	   <result property="flightDate" column="FLIGHT_DATE"/>
	   <result property="flyTime" column="FLY_TIME"/>
		<result property="id" column="id"/>
	   <result property="flight" column="FLIGHT"/>
	   <result property="flightNo" column="FLIGHT_NO"/>	   
	</resultMap>  
	<resultMap class="com.roc.syspe.entity.OpOrdertickets" id="ooOrderCounts">
		<result property="counts" column="counts"/>
	   <result property="ticketpointId" column="TICKETPOINT_ID"/>	   
	</resultMap>
	<resultMap class="com.roc.syspe.entity.OpOrdertickets" id="ooUserUnitsCount">
		<result property="counts" column="counts"/>
	   <result property="realAmount" column="REAL_AMOUNT"/>	 
	    <result property="discountType" column="DISCOUNT_TYPE"/>
	     <result property="flight" column="FLIGHT"/>  
	</resultMap>
	<resultMap class="com.roc.syspe.entity.OpOrdertickets" id="ooUserUnitsCount1">
		<result property="counts" column="counts"/>
	   <result property="name" column="name"/>	 
	   
	     <result property="flight" column="FLIGHT"/>  
	</resultMap>
	<resultMap class="com.roc.syspe.entity.OpOrdertickets" id="ooUserOperLog">
		<result property="flightDate" column="FLIGHT_DATE"/>
			<result property="ids" column="ids"/>
			<result property="gateTime" column="GATE_TIME"/>
			<result property="flightinfoId" column="FLIGHTINFO_ID"/>
			<result property="status" column="STATUS"/>
			<result property="name" column="NAME"/>
			<result property="certType" column="CERT_TYPE"/>
				<result property="certNo" column="CERT_NO"/>
				<result property="linkphone" column="LINKPHONE"/>
				<result property="vipFlag" column="VIP_FLAG"/>
				<result property="ticketpointId" column="TICKETPOINT_ID"/>					
				<result property="flightNo" column="FLIGHT_NO"/>
				<result property="payment" column="PAYMENT"/>
				<result property="ticketprice" column="TICKETPRICE"/>
				<result property="gate" column="GATE"/>	
				<result property="halfpricecard" column="HALFPRICECARD"/>
				<result property="zeropricecard" column="ZEROPRICECARD"/>	
				 <result property="createdate" column="CREATE_DATE"/>
				 <result property="id" column="id"/>
				 <result property="flight" column="FLIGHT"/>	
				 <result property="username" column="username"/>
			<result property="type" column="TYPE"/>
			<result property="bagNum" column="bag_num"/>
	</resultMap>
	<resultMap class="com.roc.syspe.entity.OpOrdertickets" id="ooSeatnumlist">
		<result property="seatNum" column="SEAT_NUM"/>	  
	</resultMap>
	 <resultMap class="com.roc.syspe.entity.OpOrdertickets" id="ooForBagNum">
    	<result property="bagNum" column="BAG_NUM"/>
    </resultMap>
    <resultMap class="com.roc.syspe.entity.OpOrdertickets" id="ooUserYearUnitsCount">
		<result property="counts" column="counts"/>
	   <result property="realAmount" column="REAL_AMOUNT"/>	 
	    <result property="discountType" column="DISCOUNT_TYPE"/>
	     <result property="flight" column="FLIGHT"/> 
	     
	</resultMap>
	<resultMap class="com.roc.syspe.entity.OpOrdertickets" id="ooUserYearUnitsForIDS">
		<result property="month" column="mth"/> 
	    <result property="day" column="day"/> 
		<result property="id" column="id"/>	   
	</resultMap>
    
    <select id="orderticketsBagNum" parameterClass="com.roc.syspe.entity.OpOrdertickets" resultMap="ooForBagNum">
    	SELECT BAG_NUM from op_ordertickets where id=#id#
    </select>
     <update id="updateBagnum" parameterClass="com.roc.syspe.entity.OpOrdertickets" >
      		update op_ordertickets set BAG_NUM=#bagNum# where id=#id#
      </update>
     <select id="orderticketsList" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooOpOrdertickets">
    SELECT a.TEAM_NAME,a.bag_num,a.TEAMFLAG,a.PRICE_ID,a.GATE_TIME,a.SEAT_NUM,a.FLIGHTINFO_ID, a.STATUS, a.NAME,a.CERT_TYPE,a.CERT_NO,a.LINKPHONE,
		a.VIP_FLAG,a.TICKETPOINT_ID,b.FLIGHT_NO,a.PAYMENT,a.TICKETPRICE,a.REMARK,a.GATE,a.HALFPRICECARD,
		a.ZEROPRICECARD,a.CREATEDATE,a.DELETE_FLAG,a.ID,a.LUGG_SUM,a.WEIGHT_SUM,b.FLIGHT_ID,c.FLIGHT,b.FLIGHT_DATE,b.FLY_TIME,d.name ticketpointname
	    FROM op_ordertickets a,ba_flightinfo b,ba_flight c,ba_ticketpoint d 
	    where a.status not in('8','9') and a.TICKETPOINT_ID=d.id and a.flightinfo_id=b.id and b.flight_id=c.id and b.delete_flag!=1 and c.delete_flag!=1   
    	 <isNotEmpty prepend="and" property="seleFlightInfo">
                        (b.id = #seleFlightInfo#)
      </isNotEmpty> 
      <isNotEmpty  prepend="and" property="seleFlightInfos">
     	 	b.id  in ($seleFlightInfos$)
      </isNotEmpty>
       <isNotEmpty prepend="and" property="id">
                        (a.id = #id#)
      </isNotEmpty>
      order by a.STATUS, a.flightinfo_id,CONVERT(a.name USING gbk )  
      </select>
      <select id="allInfoList" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooOpOrdertickets">
    SELECT a.TEAM_NAME,a.bag_num,a.TEAMFLAG,a.PRICE_ID,a.GATE_TIME,a.SEAT_NUM,a.FLIGHTINFO_ID, a.STATUS, a.NAME,a.CERT_TYPE,a.CERT_NO,a.LINKPHONE,
		a.VIP_FLAG,a.TICKETPOINT_ID,b.FLIGHT_NO,a.PAYMENT,a.TICKETPRICE,a.REMARK,a.GATE,a.HALFPRICECARD,
		a.ZEROPRICECARD,a.CREATEDATE,a.DELETE_FLAG,a.ID,a.LUGG_SUM,a.WEIGHT_SUM,b.FLIGHT_ID,c.FLIGHT,b.FLIGHT_DATE,b.FLY_TIME,d.name ticketpointname
	    FROM op_ordertickets a,ba_flightinfo b,ba_flight c,ba_ticketpoint d 
	    where  a.TICKETPOINT_ID=d.id and a.flightinfo_id=b.id and b.flight_id=c.id   
    	 <isNotEmpty prepend="and" property="seleFlightInfo">
                        (b.id = #seleFlightInfo#)
      </isNotEmpty> 
      <isNotEmpty prepend="and" property="seleFlightInfos">
                        (b.id in  ($seleFlightInfos$))
      </isNotEmpty> 
       <isNotEmpty prepend="and" property="id">
                        (a.id = #id#)
      </isNotEmpty>
      order by a.STATUS,a.TICKETPOINT_ID,CONVERT(a.name USING gbk )  
      </select>
      <select id="teamSaltOrUpList" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooOpOrdertickets">
    SELECT a.bag_num,a.TEAM_NAME,a.TEAMFLAG,a.PRICE_ID,a.GATE_TIME,a.SEAT_NUM,a.FLIGHTINFO_ID, a.STATUS, a.NAME,a.CERT_TYPE,a.CERT_NO,a.LINKPHONE,
		a.VIP_FLAG,a.TICKETPOINT_ID,b.FLIGHT_NO,a.PAYMENT,a.TICKETPRICE,a.REMARK,a.GATE,a.HALFPRICECARD,
		a.ZEROPRICECARD,a.CREATEDATE,a.DELETE_FLAG,a.ID,a.LUGG_SUM,a.WEIGHT_SUM,b.FLIGHT_ID,c.FLIGHT,b.FLIGHT_DATE,b.FLY_TIME,d.name ticketpointname
	    FROM op_ordertickets a,ba_flightinfo b,ba_flight c,ba_ticketpoint d 
	    where   a.TICKETPOINT_ID=d.id and a.flightinfo_id=b.id and b.flight_id=c.id and b.delete_flag!=1 and c.delete_flag!=1   
    	 <isNotEmpty prepend="and" property="status"> (a.status in (0,1)) </isNotEmpty> 
       <isNotEmpty prepend="and" property="teamName"> (a.teamflag=1 and a.team_name = #teamName#)</isNotEmpty>
        <isNotEmpty prepend="and" property="seleFlightInfo"> (b.id = #seleFlightInfo#) </isNotEmpty> 
      <isNotEmpty prepend="and" property="seleFlightInfos"> (b.id in ($seleFlightInfos$)) </isNotEmpty> 
      order by a.STATUS,a.TICKETPOINT_ID,CONVERT(a.name USING gbk )  
      </select>
      
      <select id="zhidengjiticketsList" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooOpOrdertickets">
	    SELECT a.bag_num,a.TEAM_NAME,a.TEAMFLAG,a.PRICE_ID,a.GATE_TIME,a.SEAT_NUM,a.FLIGHTINFO_ID, a.STATUS, a.NAME,a.CERT_TYPE,a.CERT_NO,a.LINKPHONE,	a.VIP_FLAG,a.TICKETPOINT_ID,b.FLIGHT_NO,a.PAYMENT,a.TICKETPRICE,a.REMARK,a.GATE,a.HALFPRICECARD,
			a.ZEROPRICECARD,a.CREATEDATE,a.DELETE_FLAG,a.ID,a.LUGG_SUM,a.WEIGHT_SUM,b.FLIGHT_ID,c.FLIGHT,b.FLIGHT_DATE,b.FLY_TIME,d.name ticketpointname   FROM op_ordertickets a,ba_flightinfo b,ba_flight c,ba_ticketpoint d 
	   		 where a.status  in('2','3','4') and a.flightinfo_id=b.id and b.flight_id=c.id and b.delete_flag!=1 and c.delete_flag!=1  and a.TICKETPOINT_ID=d.id 
   			 <isNotEmpty prepend="and" property="seleFlightInfo">(b.id = #seleFlightInfo#) </isNotEmpty>
   			 <isNotEmpty prepend="and" property="seleFlightInfos">(b.id in  ($seleFlightInfos$)) </isNotEmpty>
   			  order by a.STATUS, CONVERT(a.name USING gbk ) 
      </select>
      
      <select id="baFlightInfoList" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooBaFligInfo">
      	select a.id,a.FLIGHT_ID,a.FLIGHT_DATE,a.FLY_TIME,b.FLIGHT,a.FLIGHT_NO from ba_flightinfo a,ba_flight b
      	 where a.flight_id=b.id  and b.delete_flag!=1 
      	 <isNotEmpty prepend="and" property="seleFlightId">(FLIGHT_ID=#seleFlightId#)</isNotEmpty>
      	  and FLIGHT_DATE=#seleDate# and FLY_TIME=#flyTime# and a.delete_flag!=1
      </select>
      <select id="groupTiecketCount" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooOrderCounts">
      	select count(*) counts,TICKETPOINT_ID from op_ordertickets  where status!=9 and status!=8 
      	<isNotEmpty prepend="and" property="seleFlightInfo">
              FLIGHTINFO_ID =#seleFlightInfo# 
      </isNotEmpty> 
      <isNotEmpty  prepend="and" property="seleFlightInfos">
     	 	FLIGHTINFO_ID  in ($seleFlightInfos$)
      </isNotEmpty>
      	<isNotEmpty prepend="and" property="id">(ID != #id#)</isNotEmpty>
      	<isNotEmpty prepend="and" property="seleStatus">(status in (0,1))</isNotEmpty>
      	 <isNotEmpty prepend="and" property="ticketPointId">(TICKETPOINT_ID = #ticketPointId#)</isNotEmpty>  group by TICKETPOINT_ID
      </select>
      
      <select id="getbaFlightInfoForIn" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooBaFligInfo">
      	select a.id,a.FLIGHT_ID,a.FLIGHT_DATE,a.FLY_TIME,b.FLIGHT,a.FLIGHT_NO from ba_flightinfo a,ba_flight b 
      	where a.flight_id=b.id  and b.delete_flag!=1  and a.id=#seleFlightInfo# and a.delete_flag!=1
      </select>
     <insert id="insertOpOrderticket" parameterClass="com.roc.syspe.entity.OpOrdertickets">
       INSERT INTO op_ordertickets (FLIGHTINFO_ID, STATUS, NAME, CERT_TYPE, CERT_NO, LINKPHONE, VIP_FLAG, 
		TICKETPOINT_ID, FLIGHT_NO, PAYMENT, TICKETPRICE, REMARK, CREATEDATE, DELETE_FLAG,PRICE_ID,HALFPRICECARD,ZEROPRICECARD,TEAM_NAME,TEAMFLAG) 
    	VALUES(#flightinfoId#,#status#, #name#, #certType#,#certNo#, #linkphone#, #vipFlag#, #ticketpointId#, #flightNo#, #payment#, #ticketprice#, #remark#,current_timestamp(), '0',#priceId#,#halfpricecard#,#zeropricecard#,#teamName#,#teamflag#)
   		<selectKey resultClass="java.lang.Integer" keyProperty="id">     
        	SELECT LAST_INSERT_ID()
        </selectKey>  
    </insert>      
    <update id="editOpOrderticket" parameterClass="com.roc.syspe.entity.OpOrdertickets">
        update op_ordertickets set price_id= #priceId#,STATUS=#status#, NAME=#name#, CERT_TYPE=#certType#, CERT_NO=#certNo#, LINKPHONE=#linkphone#, VIP_FLAG=#vipFlag#, 
			TEAMFLAG=#teamflag#,TEAM_NAME=#teamName#,TICKETPOINT_ID=#ticketpointId#,   TICKETPRICE=#ticketprice#, REMARK=#remark#,HALFPRICECARD=#halfpricecard#,ZEROPRICECARD=#zeropricecard#,PAYMENT=#payment#
 			where id=#id#
    </update>
    <insert id="insertOpUseroperInfo" parameterClass="com.roc.enp.entity.OpUseroper">
    	insert into op_useroper (user_id,type,order_id,create_date) values(#userId#,#type#,#orderId#,current_timestamp())
    </insert>
    <update id="tgOpOrderticket" parameterClass="com.roc.syspe.entity.OpOrdertickets">
        update op_ordertickets set SEAT_NUM = #seatNum# , FLIGHTINFO_ID=#flightinfoId#,TICKETPOINT_ID=#ticketpointId# <isNotEmpty property="status" prepend=",">STATUS=#status#</isNotEmpty>
 			where id=#id#
    </update>
    <update id="tpOrtdOpOrderticket" parameterClass="com.roc.syspe.entity.OpOrdertickets">
        update op_ordertickets set STATUS=#status# where id=#id#
    </update>
    <update id="updateForDjp" parameterClass="com.roc.syspe.entity.OpOrdertickets">
        update op_ordertickets set GATE=#gate#,STATUS=#status#,GATE_TIME=#gateTime# ,SEAT_NUM=#seatNum#,LUGG_SUM=#luggSum#,WEIGHT_SUM=#weightSum# where id=#id#
     </update>
     <update id="bentchUpFlightNo" parameterClass="com.roc.syspe.entity.OpOrdertickets">
        update ba_flightinfo set FLIGHT_NO=#flightNo# where id=#flightinfoId#
     </update>
     <select id="userUnitInList" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword"  resultMap="ooForUnitsInfos">
     	SELECT a.PRICE_ID,a.GATE_TIME,a.FLIGHTINFO_ID, a.STATUS, a.NAME,a.CERT_TYPE,a.CERT_NO,a.LINKPHONE,
			a.VIP_FLAG,a.TICKETPOINT_ID,b.FLIGHT_NO,a.PAYMENT,a.TICKETPRICE,a.REMARK,a.GATE,a.HALFPRICECARD,
			a.ZEROPRICECARD,a.CREATEDATE,a.DELETE_FLAG,a.ID,a.LUGG_SUM,a.WEIGHT_SUM,b.FLIGHT_ID,c.FLIGHT,b.FLIGHT_DATE,d.DISCOUNT_TYPE,d.REAL_AMOUNT
		    FROM ba_flightinfo b,ba_flight c,ba_ticketprice d,op_ordertickets a,(select p.ORDER_ID from op_useroper p where 1=1
		    <isNotEmpty property="userId" prepend="and"> p.USER_ID =#userId# </isNotEmpty> 
		    <isNotEmpty property="type" prepend="and"> p.TYPE=#type# </isNotEmpty> 
		    <isNotEmpty property="startDate" prepend="and">  <![CDATA[ p.CREATE_DATE>=#startDate# ]]> </isNotEmpty> <isNotEmpty prepend="and" property="endDate"> <![CDATA[ p.create_date <=#endDate# ]]> </isNotEmpty>
		    ) as e
		    where  a.flightinfo_id=b.id and b.flight_id=c.id   and a.PRICE_ID = d.ID
		    and  e.ORDER_ID = a.id
     </select>
     <select id="userInfoCounts" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword"  resultMap="ooUserUnitsCount">
     	SELECT c.FLIGHT,d.DISCOUNT_TYPE,d.REAL_AMOUNT,count(d.ID) counts
		    FROM ba_flightinfo b,ba_flight c,ba_ticketprice d,op_ordertickets a,(select p.ORDER_ID from op_useroper p,dis_users us where p.USER_ID=us.userid  
		      <isNotEmpty property="im" prepend="and">  us.im =#im# </isNotEmpty> <isNotEmpty property="userId" prepend="and"> p.USER_ID =#userId# </isNotEmpty> <isNotEmpty property="type" prepend="and"> p.TYPE=#type# </isNotEmpty> <isNotEmpty property="startDate" prepend="and"> <![CDATA[ p.CREATE_DATE>=#startDate# ]]> </isNotEmpty> <isNotEmpty prepend="and" property="endDate"> <![CDATA[ p.create_date <=#endDate# ]]> </isNotEmpty>
		     ) as e
		    where  a.flightinfo_id=b.id and b.flight_id=c.id   and  d.ID=a.PRICE_ID 
		    and  e.order_id=a.id
			group by d.DISCOUNT_TYPE order by c.FLIGHT     	
     	
     </select>
     <select id="userOperLogList" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword"  resultMap="ooUserOperLog">
     	SELECT a.bag_num,p.ID ids,a.GATE_TIME,a.FLIGHTINFO_ID, a.STATUS, a.NAME,a.CERT_TYPE,a.CERT_NO,a.LINKPHONE,
			a.VIP_FLAG,a.TICKETPOINT_ID,b.FLIGHT_NO,a.PAYMENT,a.TICKETPRICE,a.GATE,a.HALFPRICECARD,
			a.ZEROPRICECARD,p.CREATE_DATE,a.ID,c.FLIGHT,b.FLIGHT_DATE
            ,p.TYPE,u.name username
		    FROM op_useroper p,op_ordertickets a,ba_flightinfo b,ba_flight c,dis_users u
		    where  a.flightinfo_id=b.id and b.flight_id=c.id   		    
		    and p.USER_ID = u.userid and p.ORDER_ID = a.ID 
		    <isNotEmpty prepend="and" property="startDate">
				<![CDATA[ p.CREATE_DATE >= #startDate# and p.CREATE_DATE <=concat(#startDate#,' 23:59:59')]]>
			</isNotEmpty>			
			<isNotEmpty prepend="and" property="name">
				<![CDATA[ u.name like #name# ]]>
			</isNotEmpty>
			<isNotEmpty prepend="and" property="username">
				<![CDATA[ a.name like #username# ]]>
			</isNotEmpty>
		    order by p.ID desc               
            limit #startNumber#,#endNumber#
		      
     </select>
     
     <select id="customerLogList" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword"  resultMap="ooUserOperLog">
     	SELECT a.bag_num,p.ID ids,a.GATE_TIME,a.FLIGHTINFO_ID, a.STATUS, a.NAME,a.CERT_TYPE,a.CERT_NO,a.LINKPHONE,
			a.VIP_FLAG,a.TICKETPOINT_ID,b.FLIGHT_NO,a.PAYMENT,a.TICKETPRICE,a.GATE,a.HALFPRICECARD,
			a.ZEROPRICECARD,p.CREATE_DATE,a.ID,c.FLIGHT,b.FLIGHT_DATE
            ,p.TYPE,u.name username
		    FROM op_useroper p,op_ordertickets a,ba_flightinfo b,ba_flight c,dis_users u
		    where  a.flightinfo_id=b.id and b.flight_id=c.id   		    
		    and p.USER_ID = u.userid and p.ORDER_ID = a.ID 
		    <isNotEmpty prepend="and" property="certNo">
				<![CDATA[ a.CERT_NO = #certNo# ]]>
			</isNotEmpty>			
			<isNotEmpty prepend="and" property="name">
				<![CDATA[ a.name = #name# ]]>
			</isNotEmpty>
		    order by p.CREATE_DATE desc               
            limit #startNumber#,#endNumber#
		      
     </select>
     
     <select id="userOperLogCount" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword"  resultClass="java.lang.Integer">
     	SELECT count(p.ID )
			FROM op_useroper p,op_ordertickets a,ba_flightinfo b,ba_flight c,dis_users u
		    where  a.flightinfo_id=b.id and b.flight_id=c.id   		    
		    and p.USER_ID = u.userid and p.ORDER_ID = a.ID   
		     <isNotEmpty prepend="and" property="startDate">
				<![CDATA[ p.CREATE_DATE >= #startDate# and p.CREATE_DATE <=concat(#startDate#,' 23:59:59')]]>
			</isNotEmpty>
			<isNotEmpty prepend="and" property="name">
				<![CDATA[ u.name like #name# ]]>
			</isNotEmpty>
			<isNotEmpty prepend="and" property="username">
				<![CDATA[ a.name like #username# ]]>
			</isNotEmpty>
     </select>
     <select id="customerLogCount" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword"  resultClass="java.lang.Integer">
     	SELECT count(p.ID )
			FROM op_useroper p,op_ordertickets a,ba_flightinfo b,ba_flight c,dis_users u
		    where  a.flightinfo_id=b.id and b.flight_id=c.id   		
		    and p.USER_ID = u.userid and p.ORDER_ID = a.ID      
		     <isNotEmpty prepend="and" property="certNo">
				<![CDATA[ a.CERT_NO = #certNo# ]]>
			</isNotEmpty>
			<isNotEmpty prepend="and" property="name">
				<![CDATA[ a.name = #name# ]]>
			</isNotEmpty>
     </select>
     <select id="flightInfoSeatNumList" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooSeatnumlist">
     	SELECT a.SEAT_NUM	FROM  op_ordertickets a where a.STATUS not in ('8','9') and a.SEAT_NUM is not  null and a.SEAT_NUM !='' 
     	<isNotEmpty prepend="and" property="seleFlightInfos">
				 a.FLIGHTINFO_ID in ($seleFlightInfos$)
		</isNotEmpty>
     </select>
      <select id="getAllCountInfoForUnits" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword"  resultMap="ooUserUnitsCount">
      	SELECT c.FLIGHT,d.DISCOUNT_TYPE,d.REAL_AMOUNT,count(d.ID) counts
		    FROM op_ordertickets a,ba_flightinfo b,ba_flight c,ba_ticketprice d
		    where  a.flightinfo_id=b.id and b.flight_id=c.id   and  d.ID=a.PRICE_ID 
		    and a.status in ('3','4','7') <isNotEmpty property="startDate" prepend="and"> <![CDATA[ b.FLIGHT_DATE>=#startDate# ]]> </isNotEmpty> <isNotEmpty prepend="and" property="endDate"> <![CDATA[ b.FLIGHT_DATE <=#endDate# ]]> </isNotEmpty>
		   <isNotEmpty property="seleFlightId" prepend="and"> <![CDATA[ b.FLIGHT_ID=#seleFlightId# ]]> </isNotEmpty> 
		    group by d.DISCOUNT_TYPE 
      </select>
      <select id="isHasSeat" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultClass="java.lang.Integer">
      	SELECT count(a.ID) counts
		    FROM op_ordertickets a,ba_flightinfo b
		    where  a.flightinfo_id=b.id  and a.STATUS not in('8','9')
            and a.ID != #id# and a.SEAT_NUM = #seatNum# 
            <isNotEmpty property="seleFlightInfos" prepend="and"> b.id in($seleFlightInfos$) </isNotEmpty> 
            <isNotEmpty property="ids" prepend="and"> <![CDATA[ a.id not in(#ids#) ]]> </isNotEmpty> 
      </select>
      <select id="queryByFlightInfoId" parameterClass="java.lang.String" resultMap="ooRMKZZX">
      	select a.FLIGHTINFO_ID,a.STATUS,a.NAME,a.CERT_TYPE,a.CERT_NO,a.LINKPHONE,a.VIP_FLAG,a.TICKETPOINT_ID,
      		b.FLIGHT_NO,a.PAYMENT,a.TICKETPRICE,a.REMARK,a.GATE,a.HALFPRICECARD,a.ZEROPRICECARD,a.CREATEDATE,
      			a.DELETE_FLAG,a.ID,a.LUGG_SUM,a.WEIGHT_SUM,c.FLIGHT,b.FLIGHT_DATE,b.FLY_TIME
      	from op_ordertickets a,ba_flightinfo b,ba_flight c where a.delete_flag!=1 and b.delete_flag!=1 and c.delete_flag!=1 and a.flightinfo_id=b.id and b.flight_id=c.id  and a.FLIGHTINFO_ID in ($value$) and(a.STATUS="2" or a.STATUS="3" or a.STATUS="4"  or a.STATUS="7")
      				  order by a.STATUS      
      </select>
    
      <update id="updateStatusAtDJP" parameterClass="java.lang.Integer" >
      		update op_ordertickets set status=4 where id=#value#
      </update>
      <update id="updateStatusOver" parameterClass="java.lang.Integer" >
      		update op_ordertickets set status=7 where id=#value#
      </update>
      <select id="selectStatusByCustomerId" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultClass="java.lang.Integer">
      		select count(*) from op_ordertickets a where a.ID=#id# and a.FLIGHTINFO_ID in ($seleFlightInfos$) and a.STATUS=3
      </select>
      <select id="selectStatusForOver" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultClass="java.lang.Integer">
      		select count(*) from op_ordertickets a 
      		where a.ID=#id# and a.FLIGHTINFO_ID in ($seleFlightInfos$) and a.STATUS=4
      </select>
      
      <select id="mainPageForDJP" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultClass="java.lang.Integer">
      	select count(*) from op_ordertickets a,ba_flightinfo b where a.flightinfo_id=b.id  and b.delete_flag!=1   and b.FLIGHT_DATE=#seleDate# and b.FLY_TIME=#flyTime# and a.delete_flag!=1
      </select>
      
      <select id="listForReserveDJP" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooAtDJP">
      	select a.ID,a.NAME,a.STATUS,a.SEAT_NUM,a.LINKPHONE,a.CERT_TYPE,a.CERT_NO,b.flight_no,c.FLIGHT 
      	from op_ordertickets a,ba_flightinfo b ,ba_flight c
      	where c.id=b.flight_id and a.flightinfo_id=b.id  and b.delete_flag!=1   and b.FLIGHT_DATE=#seleDate# and b.FLY_TIME=#flyTime# and a.delete_flag!=1 and a.STATUS='2'
      </select>
      
      <select id="listForChargeDJP" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooAtDJP">
      	select a.ID,a.NAME,a.STATUS,a.SEAT_NUM,a.LINKPHONE,a.CERT_TYPE,a.CERT_NO,b.flight_no,c.FLIGHT 
      	from op_ordertickets a,ba_flightinfo b ,ba_flight c
      	where c.id=b.flight_id and a.flightinfo_id=b.id  and b.delete_flag!=1   and b.FLIGHT_DATE=#seleDate# and b.FLY_TIME=#flyTime# and a.delete_flag!=1 and a.STATUS='3'
      </select>
      
      <select id="listForChargedDJP" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooAtDJP">
      	select a.ID,a.NAME,a.STATUS,a.SEAT_NUM,a.LINKPHONE,a.CERT_TYPE,a.CERT_NO,b.flight_no ,c.FLIGHT
      	from op_ordertickets a,ba_flightinfo b ,ba_flight c
      	where c.id=b.flight_id and  a.flightinfo_id=b.id  and b.delete_flag!=1   and b.FLIGHT_DATE=#seleDate# and b.FLY_TIME=#flyTime# and a.delete_flag!=1 and a.STATUS='4'
      </select>
      
       <select id="listForInFly" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooAtDJP">
      	select a.ID,a.NAME,a.STATUS,a.SEAT_NUM,a.LINKPHONE,a.CERT_TYPE,a.CERT_NO,b.flight_no ,c.FLIGHT
      	from op_ordertickets a,ba_flightinfo b ,ba_flight c
      	where c.id=b.flight_id and a.flightinfo_id=b.id  and b.delete_flag!=1   and b.FLIGHT_DATE=#seleDate# and b.FLY_TIME=#flyTime# and a.delete_flag!=1 and a.STATUS='7'
      </select>
      <select id="authInfoIsHas" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultClass="java.lang.Integer">
      	select count(*) from op_ordertickets a where a.CERT_TYPE=#certType# and a.CERT_NO=#certNo# 
      	and a.status not in('8','9')
      	<isNotEmpty  prepend="and" property="seleFlightInfo">
     	 	a.FLIGHTINFO_ID=#seleFlightInfo# 
      	</isNotEmpty>
      	<isNotEmpty  prepend="and" property="seleFlightInfos">
     	 	a.FLIGHTINFO_ID  in ($seleFlightInfos$)
      	</isNotEmpty>
      </select>
      <select id="getOrderStatus" parameterClass="java.lang.Integer" resultClass="java.lang.String">
      	select status from op_ordertickets where id=#value#
      </select>
      <select id="teamDjpList" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooOpOrdertickets">
    SELECT a.bag_num,a.TEAM_NAME,a.TEAMFLAG,a.PRICE_ID,a.GATE_TIME,a.SEAT_NUM,a.FLIGHTINFO_ID, a.STATUS, a.NAME,a.CERT_TYPE,a.CERT_NO,a.LINKPHONE,
		a.VIP_FLAG,a.TICKETPOINT_ID,b.FLIGHT_NO,a.PAYMENT,a.TICKETPRICE,a.REMARK,a.GATE,a.HALFPRICECARD,
		a.ZEROPRICECARD,a.CREATEDATE,a.DELETE_FLAG,a.ID,a.LUGG_SUM,a.WEIGHT_SUM,b.FLIGHT_ID,c.FLIGHT,b.FLIGHT_DATE,b.FLY_TIME,d.name ticketpointname
	    FROM op_ordertickets a,ba_flightinfo b,ba_flight c,ba_ticketpoint d 
	    where   a.TICKETPOINT_ID=d.id and a.flightinfo_id=b.id and b.flight_id=c.id and b.delete_flag!=1 and c.delete_flag!=1   
    	 <isNotEmpty prepend="and" property="status"> (a.status=#status#) </isNotEmpty> 
       <isNotEmpty prepend="and" property="teamName"> (a.teamflag=1 and a.team_name = #teamName#)</isNotEmpty>
        <isNotEmpty prepend="and" property="seleFlightInfo"> (b.id = #seleFlightInfo#) </isNotEmpty> 
      <isNotEmpty prepend="and" property="seleFlightInfos"> (b.id in ($seleFlightInfos$)) </isNotEmpty>
      order by a.STATUS,a.TICKETPOINT_ID,CONVERT(a.name USING gbk )  
      </select>
      
       <select id="saltPointInfoCounts" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword"  resultMap="ooUserUnitsCount1">
     	SELECT c.FLIGHT,d.name,count(a.ID) counts
		    FROM op_ordertickets a,ba_flightinfo b,ba_flight c,ba_ticketpoint d
		    where  a.FLIGHTINFO_ID=b.id and a.TICKETPOINT_ID=d.id
    		 and  b.FLIGHT_ID=c.id
    		 <isNotEmpty prepend="and" property="status"> (a.status in ('3','4','7')) </isNotEmpty> 
    		 <isNotEmpty prepend="and" property="startDate"> 
    		 <![CDATA[b.FLIGHT_DATE>=#startDate# and b.FLIGHT_DATE<=concat(#startDate#,' 23:59:59')]]>
    		</isNotEmpty>
    		group by d.id
     </select>
     <select id="getCountByFlightInfoIdSeatNum" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultClass="java.lang.Integer">
      		select count(*) from op_ordertickets a where a.FLIGHTINFO_ID=#seleFlightInfo# and a.SEAT_NUM=#seatNum# and a.STATUS="3"
      </select>
      <update id="updateStatusAtDJPForSeatNum" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" >
      		update op_ordertickets set status=4 where FLIGHTINFO_ID=#seleFlightInfo# and SEAT_NUM=#seatNum# and STATUS="3"
      </update>
      <select id="getFlightIds" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultClass="java.lang.Integer">
      		select id from ba_flight a where delete_flag != 0
      </select>
      <!-- 1、获得航程的id 2、通过航程和年份得到航班信息id列表 3、获得航班统计结果 -->
       
       <select id="getFlightInfoIdsByYearAndFlightID" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooUserYearUnitsForIDS">
      		select  a.id,MONTH( a.FLIGHT_DATE) as mth,DAY(a.FLIGHT_DATE) as day from ba_flightinfo a 
				where a.DELETE_FLAG != 1 
					 <isNotEmpty prepend="and" property="year"> 
						YEAR(a.FLIGHT_DATE)=#year# 
					 </isNotEmpty>
					 <isNotEmpty prepend="and" property="flightId"> 
						 a.flight_id=#flightId# 
					 </isNotEmpty> 
					 order by a.FLIGHT_DATE 
      </select>
      <select id="getThreeCounts" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooUserYearUnitsCount">
      		SELECT   c.FLIGHT,d.DISCOUNT_TYPE,d.REAL_AMOUNT,count(d.ID) counts
			 FROM op_ordertickets a,ba_flightinfo b,ba_flight c,ba_ticketprice d
			 where  a.flightinfo_id=b.id and b.flight_id=c.id   and  d.ID=a.PRICE_ID 
				and a.status in ('3','4','7')
				<isNotEmpty prepend="and" property="seleFlightInfo"> 
						 b.id=#seleFlightInfo#
				</isNotEmpty>		
				group by d.DISCOUNT_TYPE 
      </select>
      
       <select id="zhidengjiticketsListForException" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooOpOrdertickets">
	    	SELECT a.bag_num,a.TEAM_NAME,a.TEAMFLAG,a.PRICE_ID,a.GATE_TIME,a.SEAT_NUM,a.FLIGHTINFO_ID, a.STATUS, a.NAME,a.CERT_TYPE,a.CERT_NO,a.LINKPHONE,	a.VIP_FLAG,a.TICKETPOINT_ID,b.FLIGHT_NO,a.PAYMENT,a.TICKETPRICE,a.REMARK,a.GATE,a.HALFPRICECARD,
				a.ZEROPRICECARD,a.CREATEDATE,a.DELETE_FLAG,a.ID,a.LUGG_SUM,a.WEIGHT_SUM,b.FLIGHT_ID,c.FLIGHT,b.FLIGHT_DATE,b.FLY_TIME,d.name ticketpointname   
				FROM op_ordertickets a,ba_flightinfo b,ba_flight c,ba_ticketpoint d 
		   		 where a.status  in('2') and a.flightinfo_id=b.id and b.flight_id=c.id and b.delete_flag!=1 and c.delete_flag!=1  and a.TICKETPOINT_ID=d.id 
	   			 <isNotEmpty property="startDate" prepend="and">
	   			 	 <![CDATA[ b.FLIGHT_DATE>=#startDate# ]]>
	   			  </isNotEmpty>
	   			  <isNotEmpty prepend="and" property="endDate"><![CDATA[ b.FLIGHT_DATE <=#endDate# ]]> </isNotEmpty>
	   			 order by a.STATUS, CONVERT(a.name USING gbk ) 
      </select>
      <select id="queryGroupOrderTicketInfos" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooOrderCounts">
      	SELECT	count(s.id) counts,	s.TICKETPOINT_ID,  s.FLIGHTINFO_ID FROM
		op_ordertickets s INNER JOIN ba_flightinfo a on s.FLIGHTINFO_ID=a.ID
		WHERE
			s.STATUS != 9
			AND s.STATUS != 8
     	 	and s.FLIGHTINFO_ID  = #seleFlightInfo#
     	 	and s.TICKETPOINT_ID = #ticketPointId#
      	<isNotEmpty prepend="and" property="seleStatus">(s.status in (0,1))</isNotEmpty>
      	 GROUP BY s.TICKETPOINT_ID,s.FLIGHTINFO_ID
  	</select>
  	<select id="getOrderInfoByParams" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooOpOrdertickets">
	    SELECT a.bag_num,a.TEAM_NAME,a.TEAMFLAG,a.PRICE_ID,a.GATE_TIME,a.SEAT_NUM,a.FLIGHTINFO_ID, a.STATUS, a.NAME,a.CERT_TYPE,a.CERT_NO,a.LINKPHONE,	a.VIP_FLAG,a.TICKETPOINT_ID,b.FLIGHT_NO,a.PAYMENT,a.TICKETPRICE,a.REMARK,a.GATE,a.HALFPRICECARD,
				a.ZEROPRICECARD,a.CREATEDATE,a.DELETE_FLAG,a.ID,a.LUGG_SUM,a.WEIGHT_SUM,b.FLIGHT_ID,c.FLIGHT,b.FLIGHT_DATE,b.FLY_TIME,d.name ticketpointname   
				FROM op_ordertickets a,ba_flightinfo b,ba_flight c,ba_ticketpoint d 
		   		 where 
		   		 <isEqual property="seleStatus" compareValue="1">
			        a.status not in('8','9')
			     </isEqual>
			     <isNotEqual property="seleStatus" compareValue="1">
			         a.status  in('2') 
			      </isNotEqual>
		   		 and a.flightinfo_id=b.id and b.flight_id=c.id and b.delete_flag!=1 and c.delete_flag!=1  and a.TICKETPOINT_ID=d.id 
   			 	and a.CERT_TYPE= #certType# and a.CERT_NO=#certNo#
   			 	and (b.id in  ($seleFlightInfos$)) 
   			  limit 1 
      </select>
      
   <select id="teamDjpListByIdCard" parameterClass="com.roc.syspe.entity.OpOrderticketsKeyword" resultMap="ooOpOrdertickets">
      SELECT a.bag_num,a.TEAM_NAME,a.TEAMFLAG,a.PRICE_ID,a.GATE_TIME,a.SEAT_NUM,a.FLIGHTINFO_ID, a.STATUS, a.NAME,a.CERT_TYPE,a.CERT_NO,a.LINKPHONE,
		a.VIP_FLAG,a.TICKETPOINT_ID,b.FLIGHT_NO,a.PAYMENT,a.TICKETPRICE,a.REMARK,a.GATE,a.HALFPRICECARD,
		a.ZEROPRICECARD,a.CREATEDATE,a.DELETE_FLAG,a.ID,a.LUGG_SUM,a.WEIGHT_SUM,b.FLIGHT_ID,c.FLIGHT,b.FLIGHT_DATE,b.FLY_TIME,d.name ticketpointname
	  FROM op_ordertickets a,ba_flightinfo b,ba_flight c,ba_ticketpoint d 
	  where   a.TICKETPOINT_ID=d.id 
	     and a.flightinfo_id=b.id and b.flight_id=c.id 
	     and b.delete_flag!=1 and c.delete_flag!=1   
    	 and a.status in (2,3) 
    	 <isNotEmpty prepend="and" property="startDate">
    	 	b.FLIGHT_DATE=#startDate#
    	 </isNotEmpty>
    	 <isNotEmpty prepend="and" property="certNo">
    		a.CERT_NO=#certNo#
    	 </isNotEmpty>
    	 <isNotEmpty prepend="and" property="ids">
    	 	a.id in ($ids$)
    	 </isNotEmpty>
      	order by a.STATUS,a.TICKETPOINT_ID 
      </select>
</sqlMap>

